log:
  # Set the log level. Supported levels:
  #
  # - trace
  # - debug
  # - info
  # - warn
  # - error
  # - fatal
  # - panic
  #
  level: "error"
# Analytics configuration
analytics:
  reporting:
    # Enable reporting anonymous usage statistics (DB type, Lock type, Total Size)
    # to the project maintainers
    enabled: true
# OpenTelemetry support.
opentelemetry:
  enabled: true
  # Configure open telemetry to connect to a collector with the grpc URL. If
  # not set, ncps will simply print telemetry to stdout which is not very
  # useful but can be helpful for debugging.
  grpc-url: "http://otelcol-collector.monitoring.svc:4317"
# Prometheus metrics exposed at /metrics on the same port as ncps
prometheus:
  enabled: true
# Configure the cache functionality.
cache:
  # Whether to allow the DELETE verb to delete narInfo and nar files
  allow-delete-verb: true
  # Whether to allow the PUT verb to push narInfo and nar files directly
  allow-put-verb: true
  # The hostname of the cache server
  hostname: "ncps.mycompany.tld"
  # Download configuration
  download:
    # Timeout for polling storage when waiting for download completion by another server
    poll-timeout: 30s
  # The URL of the database
  # Supports multiple database engines via URL scheme:
  #   SQLite:     sqlite:/var/lib/ncps/db/db.sqlite
  #   PostgreSQL: postgresql://user:password@localhost:5432/ncps?sslmode=require
  #   PostgreSQL: postgres://user:password@localhost:5432/ncps?sslmode=require
  #   PostgreSQL (local dev, no SSL): postgresql://user:password@localhost:5432/ncps?sslmode=disable
  #   MySQL/MariaDB: mysql://user:password@localhost:3306/ncps
  database-url: "sqlite:/var/lib/ncps/db/db.sqlite"
  # Database connection pool configuration (optional)
  # Tune these based on your database server capacity and application workload
  database:
    pool:
    # Maximum number of open connections to the database
    # If not set or 0, defaults are used based on database type:
    #   SQLite: 1 (required to avoid "database is locked" errors)
    #   PostgreSQL: 25
    #   MySQL/MariaDB: 25
    # max-open-conns: 25
    # Maximum number of idle connections in the pool
    # If not set or 0, defaults are used based on database type:
    #   SQLite: not configured (uses Go's default)
    #   PostgreSQL: 5
    #   MySQL/MariaDB: 5
    # max-idle-conns: 5
  # CDC (Content-Defined Chunking) configuration (EXPERIMENTAL)
  # Enables deduplication of NAR files by splitting them into content-defined chunks.
  # Chunks are stored in the same backend as NAR files (different prefix/directory).
  cdc:
    # Enable CDC chunking
    enabled: false
    # Minimum chunk size for CDC in bytes (default: 65536)
    min: 65536
    # Average chunk size for CDC in bytes (default: 262144)
    avg: 262144
    # Maximum chunk size for CDC in bytes (default: 1048576)
    max: 1048576
  # The maximum size of the store. It can be given with units such as 5K, 10G
  # etc. Supported units: B, K, M, G, T
  max-size: 100G
  # Configure the LRU to clean the store and purge least used nars. No nars are
  # removed unless the size approaches max-size.
  lru:
    # The cron spec for cleaning the store. Refer to
    # https://pkg.go.dev/github.com/robfig/cron/v3#hdr-Usage for documentation
    schedule: "0 0 * * *"
    # The name of the timezone to use for the cron
    timezone: America/Los_Angeles
  # The path to the secret key used for signing cached paths
  # XXX: Only set this if you intend to store the key yourself instead of having ncps store it in its config store.
  secret-key-path: ""
  # Whether to sign narInfo files or passthru as-is from upstream
  sign-narinfo: true
  storage:
    # The local data path used for configuration and cache storage
    # Use this OR S3 storage (cache.storage.s3.bucket) - not both
    local: "/var/lib/ncps"
    # S3 Storage configuration (alternative to cache.storage.local)
    # Use this for storing cache data in S3-compatible storage (AWS S3, MinIO, etc.)
    # s3:
    #   # S3 bucket name (use this OR cache.storage.local - not both)
    #   bucket: "ncps-cache"
    #   # S3-compatible endpoint URL with scheme (e.g., https://s3.amazonaws.com or http://minio.example.com:9000)
    #   endpoint: "https://s3.amazonaws.com"
    #   # AWS region (optional)
    #   region: "us-east-1"
    #   # S3 access key ID
    #   access-key-id: "your-access-key"
    #   # S3 secret access key
    #   secret-access-key: "your-secret-key"
    #   # Force path-style S3 addressing (required for MinIO, optional for AWS S3)
    #   # Set to true for MinIO and other S3-compatible services
    #   # Set to false for AWS S3 (default)
    #   force-path-style: false
  # The path to the temporary directory that is used by the cache to download NAR files
  temp-path: "/tmp"
  # Path to netrc file for upstream authentication
  netrc-file: "/etc/ncps/netrc"
  # Configure upstream caches
  upstream:
    # Set to URL (with scheme) for each upstream cache
    urls:
      - https://cache.nixos.org
      - https://nix-community.cachix.org
    # Set to host:public-key for each upstream cache
    public-keys:
      - cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      - nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
    # Timeout for establishing TCP connections to upstream caches (default: 3s)
    # Increase this if you experience connection timeouts with slow networks
    dialer-timeout: 3s
    # Timeout for waiting for upstream server's response headers (default: 3s)
    # Increase this if you see "timeout awaiting response headers" errors
    response-header-timeout: 3s
  # Redis configuration for distributed locking (OPTIONAL - for HA deployments only)
  # If not configured, local locks are used (single-instance mode)
  redis:
    # List of Redis server addresses (omit this entire section to use local locks)
    # For single node: ["localhost:6379"]
    # For cluster: ["node1:6379", "node2:6379", "node3:6379"]
    addrs:
      - "localhost:6379"
    # Username for authentication (optional, required for Redis ACL)
    username: ""
    # Password for authentication (optional)
    password: ""
    # Database number (0-15)
    db: 0
    # Enable TLS connection
    use-tls: false
    # Connection pool size (default: 10)
    pool-size: 10
  # Lock configuration
  lock:
    # Lock backend selection (optional)
    # Options: "local" (default), "redis"
    # - local: In-memory locks (single instance only)
    # - redis: Distributed locks using Redis (requires cache.redis.addrs)
    # backend: "local"

    # Redis-specific lock settings (only used when backend is "redis")
    redis:
      # Key prefix for all distributed locks (default: "ncps:lock:")
      key-prefix: "ncps:lock:"
    # Timeout for download locks (per-hash locks)
    download-lock-ttl: 5m
    # Timeout for LRU lock (global exclusive lock)
    lru-lock-ttl: 30m
    # Retry configuration for distributed locks
    retry:
      # Maximum number of retry attempts
      max-attempts: 3
      # Initial retry delay
      initial-delay: 100ms
      # Maximum retry delay (exponential backoff caps at this)
      max-delay: 2s
      # Enable jitter to prevent thundering herd
      jitter: true
    # Degraded mode: allow falling back to local locks if Redis is unavailable
    # WARNING: Only enable in emergencies - breaks HA guarantees
    allow-degraded-mode: false
# Configure the main server
server:
  # The address of the server
  addr: ":8501"
