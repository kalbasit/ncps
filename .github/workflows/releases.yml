name: Releases
permissions:
  contents: read
  packages: write
on:
  push:
    tags:
      - "v*.*.*"
jobs:
  flake:
    uses: ./.github/workflows/flake.yml
    permissions:
      id-token: "write"
      contents: "read"
    with:
      systems: "['x86_64-linux', 'aarch64-linux']"
    secrets:
      codecov_token: ${{ secrets.CODECOV_TOKEN }}
  docker:
    uses: ./.github/workflows/docker.yml
    needs: flake
    with:
      systems: "['x86_64-linux', 'aarch64-linux']"
      images: kalbasit/ncps
      username: ${{ vars.DOCKERHUB_USERNAME }}
      push_images: true
    secrets:
      password: ${{ secrets.DOCKERHUB_TOKEN }}
  helm:
    uses: ./.github/workflows/helm.yml
    needs: docker
  release:
    runs-on: ubuntu-24.04
    needs: docker
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - name: Release with Notes
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          append_body: true
          body: |
            ## Docker Images ${{ github.ref_name }}
            The following image tags were published to [Dockerhub](https://hub.docker.com/r/kalbasit/ncps):
            ```
            ${{ needs.docker.outputs.tags }}
            ```

            ## Helm Chart Release ${{ github.ref_name }}

            ### Installation

            ```bash
            helm install ncps oci://ghcr.io/${{ github.repository_owner }}/helm/ncps --version ${{ github.ref_name }}
            ```

            ### Upgrade

            ```bash
            helm upgrade ncps oci://ghcr.io/${{ github.repository_owner }}/helm/ncps --version ${{ github.ref_name }}
            ```

            ### Values

            See [values.yaml](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/charts/ncps/values.yaml) for all configuration options.

            ### Documentation

            See [Helm Chart Documentation](https://docs.ncps.dev/user-guide/installation/helm-chart) for detailed documentation and examples.
