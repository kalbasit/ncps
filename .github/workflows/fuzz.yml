name: Fuzzing
on:
  schedule:
    - cron: "0 2 * * *" # Run daily at 2 AM UTC
  workflow_dispatch:
permissions:
  contents: read
  issues: write
jobs:
  fuzz:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - pkg: pkg/nixcacheinfo
            func: FuzzParse
            fuzz_pattern: FuzzParse
            time: 1h
          - pkg: pkg/helper
            func: FuzzParseSize
            fuzz_pattern: FuzzParseSize
            time: 1h
          - pkg: pkg/nar
            func: FuzzParseURL
            fuzz_pattern: FuzzParseURL
            time: 1h
          - pkg: pkg/nar
            func: FuzzJoinURL
            fuzz_pattern: FuzzJoinURL
            time: 1h
          - pkg: pkg/nar
            func: FuzzCompressionTypeFromExtension
            fuzz_pattern: FuzzCompressionTypeFromExtension
            time: 1h
          - pkg: pkg/golomb
            func: FuzzDecode
            fuzz_pattern: ^FuzzDecode$
            time: 1h
          - pkg: pkg/golomb
            func: FuzzDecodeBig
            fuzz_pattern: ^FuzzDecodeBig$
            time: 1h
          - pkg: pkg/cache
            func: FuzzParseNarInfo
            fuzz_pattern: FuzzParseNarInfo
            time: 1h
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: ncps
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Fuzz ${{ matrix.func }}
        run: nix develop --command go test -fuzz=${{ matrix.fuzz_pattern }} -fuzztime=${{ matrix.time }} ./${{ matrix.pkg }}
      - name: Encrypt Fuzz Crash
        if: failure()
        run: |
          # Find the crash file
          CRASH_FILE=$(find ${{ matrix.pkg }}/testdata/fuzz/${{ matrix.func }} -name "crash-*" | head -n 1)
          if [ -z "$CRASH_FILE" ]; then
            echo "No crash file found despite failure."
            exit 0
          fi

          # Calculate SHA256 of the crash file
          SHA256=$(sha256sum "$CRASH_FILE" | awk '{print $1}')

          # Report SHA256
          echo "Crash file SHA256: $SHA256"
          echo "SHA256=$SHA256" >> "$GITHUB_ENV"
          echo "CRASH_FILE=$CRASH_FILE" >> "$GITHUB_ENV"
      - name: Archive crash file
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: crash-${{ matrix.func }}-${{ env.SHA256 }}
          path: ${{ env.CRASH_FILE }}
      - name: Create Issue on Crash
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$SHA256" ]; then
            echo "SHA256 not set, skipping issue creation."
            exit 0
          fi

          TITLE="Fuzzing Crash: ${{ matrix.func }} $SHA256"

          # Check for existing issue
          EXISTING_ISSUE=$(gh issue list --search "$SHA256 in:title" --json number --jq '.[0].number')
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Issue already exists: #$EXISTING_ISSUE"
            exit 0
          fi

          gh issue create \
            --title "$TITLE" \
            --body "Fuzzing test '${{ matrix.func }}' crashed.\n\nCommit: ${{ github.sha }}\nInput SHA256: \`$SHA256\`\n\nSee artifact for reproduction." \
            --label "fuzz-crash"
