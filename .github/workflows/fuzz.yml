name: Fuzzing
on:
  pull_request:
  schedule:
    - cron: "0 2 * * *" # Run daily at 2 AM UTC
  workflow_dispatch:
permissions:
  contents: read
  issues: write
jobs:
  fuzz:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - pkg: pkg/nixcacheinfo
            func: FuzzParse
            fuzz_pattern: FuzzParse
            time: 1h
          - pkg: pkg/helper
            func: FuzzParseSize
            fuzz_pattern: FuzzParseSize
            time: 1h
          - pkg: pkg/nar
            func: FuzzParseURL
            fuzz_pattern: FuzzParseURL
            time: 1h
          - pkg: pkg/nar
            func: FuzzJoinURL
            fuzz_pattern: FuzzJoinURL
            time: 1h
          - pkg: pkg/nar
            func: FuzzCompressionTypeFromExtension
            fuzz_pattern: FuzzCompressionTypeFromExtension
            time: 1h
          - pkg: pkg/golomb
            func: FuzzDecode
            fuzz_pattern: ^FuzzDecode$
            time: 1h
          - pkg: pkg/golomb
            func: FuzzDecodeBig
            fuzz_pattern: ^FuzzDecodeBig$
            time: 1h
          - pkg: pkg/golomb
            func: FuzzEncode
            fuzz_pattern: ^FuzzEncode$
            time: 1h
          - pkg: pkg/golomb
            func: FuzzEncodeBig
            fuzz_pattern: ^FuzzEncodeBig$
            time: 1h
          - pkg: pkg/cache
            func: FuzzParseNarInfo
            fuzz_pattern: FuzzParseNarInfo
            time: 1h
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31
      - uses: cachix/cachix-action@v16
        with:
          name: ncps
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Fuzz ${{ matrix.func }}
        run: nix develop --command go test -fuzz=${{ matrix.fuzz_pattern }} -fuzztime=${{ matrix.time }} ./${{ matrix.pkg }}
      - name: Archive crash file
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          path: ${{ matrix.pkg }}/testdata/fuzz/${{ matrix.func }}
      - name: Create Issue on Crash
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="Fuzzing Crash: ${{ matrix.func }} in ${{ matrix.pkg }}"

          # Check for existing issue
          EXISTING_ISSUE=$(gh issue list --search "$TITLE in:title" --json number --jq '.[0].number')
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Issue already exists: #$EXISTING_ISSUE"
            exit 0
          fi

          gh issue create \
            --title "$TITLE" \
            --body "Fuzzing test '${{ matrix.func }}' in '${{ matrix.pkg }}' crashed.\n\nCommit: ${{ github.sha }}\n\nSee artifact for reproduction." \
            --label "fuzz-crash"
