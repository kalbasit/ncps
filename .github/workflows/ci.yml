name: CI
permissions:
  contents: read
  packages: write
on:
  pull_request:
    branches:
      - main
      - "release-*"
jobs:
  flake:
    uses: ./.github/workflows/flake.yml
    permissions:
      id-token: "write"
      contents: "read"
    with:
      systems: "['x86_64-linux', 'aarch64-linux']"
  helm-tests:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.16.3"
      - name: Run Helm validation tests
        run: ./charts/ncps/tests/run-tests.sh
  docker:
    uses: ./.github/workflows/docker.yml
    with:
      systems: "['x86_64-linux', 'aarch64-linux']"
      images: kalbasit/ncps
      username: ${{ vars.DOCKERHUB_USERNAME }}
      push_images: ${{ github.event.pull_request.head.repo.fork == false }}
    secrets:
      password: ${{ secrets.DOCKERHUB_TOKEN }}
