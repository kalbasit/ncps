suite: test secret generation
templates:
  - secret.yaml
tests:
  # PostgreSQL database URL tests
  - it: should generate PostgreSQL database-url with password
    set:
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres.example.com
      config.database.postgresql.port: 5432
      config.database.postgresql.database: ncps
      config.database.postgresql.username: testuser
      config.database.postgresql.password: testpass123
      config.database.postgresql.sslMode: disable
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["postgres-password"]
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: cG9zdGdyZXNxbDovL3Rlc3R1c2VyOnRlc3RwYXNzMTIzQHBvc3RncmVzLmV4YW1wbGUuY29tOjU0MzIvbmNwcz9zc2xtb2RlPWRpc2FibGU=
          # Decodes to: postgresql://testuser:testpass123@postgres.example.com:5432/ncps?sslmode=disable

  - it: should generate PostgreSQL database-url without password
    set:
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres.example.com
      config.database.postgresql.port: 5432
      config.database.postgresql.database: ncps
      config.database.postgresql.username: testuser
      config.database.postgresql.sslMode: disable
    asserts:
      - isKind:
          of: Secret
      - notExists:
          path: data["postgres-password"]
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: cG9zdGdyZXNxbDovL3Rlc3R1c2VyQHBvc3RncmVzLmV4YW1wbGUuY29tOjU0MzIvbmNwcz9zc2xtb2RlPWRpc2FibGU=
          # Decodes to: postgresql://testuser@postgres.example.com:5432/ncps?sslmode=disable

  - it: should generate PostgreSQL database-url with password and extraParams
    set:
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres.example.com
      config.database.postgresql.port: 5432
      config.database.postgresql.database: ncps
      config.database.postgresql.username: testuser
      config.database.postgresql.password: testpass123
      config.database.postgresql.sslMode: require
      config.database.postgresql.extraParams: connect_timeout=10
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: cG9zdGdyZXNxbDovL3Rlc3R1c2VyOnRlc3RwYXNzMTIzQHBvc3RncmVzLmV4YW1wbGUuY29tOjU0MzIvbmNwcz9zc2xtb2RlPXJlcXVpcmUmY29ubmVjdF90aW1lb3V0PTEw
          # Decodes to: postgresql://testuser:testpass123@postgres.example.com:5432/ncps?sslmode=require&connect_timeout=10

  - it: should URL-encode special characters in PostgreSQL password
    set:
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres.example.com
      config.database.postgresql.port: 5432
      config.database.postgresql.database: ncps
      config.database.postgresql.username: testuser
      config.database.postgresql.password: "p@ss:w/rd!"
      config.database.postgresql.sslMode: disable
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: cG9zdGdyZXNxbDovL3Rlc3R1c2VyOnAlNDBzcyUzQXclMkZyZCUyMUBwb3N0Z3Jlcy5leGFtcGxlLmNvbTo1NDMyL25jcHM/c3NsbW9kZT1kaXNhYmxl
          # Decodes to: postgresql://testuser:p%40ss%3Aw%2Frd%21@postgres.example.com:5432/ncps?sslmode=disable

  - it: should not create secret when using PostgreSQL existingSecret
    set:
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres.example.com
      config.database.postgresql.existingSecret: my-pg-secret
    asserts:
      - hasDocuments:
          count: 0

  # MySQL database URL tests
  - it: should generate MySQL database-url with password
    set:
      config.hostname: test.example.com
      config.database.type: mysql
      config.database.mysql.host: mysql.example.com
      config.database.mysql.port: 3306
      config.database.mysql.database: ncps
      config.database.mysql.username: testuser
      config.database.mysql.password: testpass123
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["mysql-password"]
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: bXlzcWw6Ly90ZXN0dXNlcjp0ZXN0cGFzczEyM0BteXNxbC5leGFtcGxlLmNvbTozMzA2L25jcHM=
          # Decodes to: mysql://testuser:testpass123@mysql.example.com:3306/ncps

  - it: should generate MySQL database-url without password
    set:
      config.hostname: test.example.com
      config.database.type: mysql
      config.database.mysql.host: mysql.example.com
      config.database.mysql.port: 3306
      config.database.mysql.database: ncps
      config.database.mysql.username: testuser
    asserts:
      - isKind:
          of: Secret
      - notExists:
          path: data["mysql-password"]
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: bXlzcWw6Ly90ZXN0dXNlckBteXNxbC5leGFtcGxlLmNvbTozMzA2L25jcHM=
          # Decodes to: mysql://testuser@mysql.example.com:3306/ncps

  - it: should generate MySQL database-url with password and extraParams
    set:
      config.hostname: test.example.com
      config.database.type: mysql
      config.database.mysql.host: mysql.example.com
      config.database.mysql.port: 3306
      config.database.mysql.database: ncps
      config.database.mysql.username: testuser
      config.database.mysql.password: testpass123
      config.database.mysql.extraParams: timeout=10s
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: bXlzcWw6Ly90ZXN0dXNlcjp0ZXN0cGFzczEyM0BteXNxbC5leGFtcGxlLmNvbTozMzA2L25jcHM/dGltZW91dD0xMHM=
          # Decodes to: mysql://testuser:testpass123@mysql.example.com:3306/ncps?timeout=10s

  - it: should URL-encode special characters in MySQL password
    set:
      config.hostname: test.example.com
      config.database.type: mysql
      config.database.mysql.host: mysql.example.com
      config.database.mysql.port: 3306
      config.database.mysql.database: ncps
      config.database.mysql.username: testuser
      config.database.mysql.password: "p@ss:w/rd!"
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["database-url"]
      - equal:
          path: data["database-url"]
          value: bXlzcWw6Ly90ZXN0dXNlcjpwJTQwc3MlM0F3JTJGcmQlMjFAbXlzcWwuZXhhbXBsZS5jb206MzMwNi9uY3Bz
          # Decodes to: mysql://testuser:p%40ss%3Aw%2Frd%21@mysql.example.com:3306/ncps

  - it: should not create secret when using MySQL existingSecret
    set:
      config.hostname: test.example.com
      config.database.type: mysql
      config.database.mysql.host: mysql.example.com
      config.database.mysql.existingSecret: my-mysql-secret
    asserts:
      - hasDocuments:
          count: 0

  # SQLite should not create a secret
  - it: should not create secret for SQLite database
    set:
      config.hostname: test.example.com
      config.database.type: sqlite
      config.database.sqlite.path: /storage/db/ncps.db
    asserts:
      - hasDocuments:
          count: 0

  # S3 credentials tests
  - it: should create S3 credentials in secret
    set:
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: AKIAIOSFODNN7EXAMPLE
      config.storage.s3.secretAccessKey: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data["s3-access-key-id"]
          value: QUtJQUlPU0ZPRE5ON0VYQU1QTEU=
          # Decodes to: AKIAIOSFODNN7EXAMPLE
      - equal:
          path: data["s3-secret-access-key"]
          value: d0phbHJYVXRuRkVNSS9LN01ERU5HL2JQeFJmaUNZRVhBTVBMRUtFWQ==
          # Decodes to: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

  - it: should not create secret when using S3 existingSecret
    set:
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.existingSecret: my-s3-secret
    asserts:
      - hasDocuments:
          count: 0

  # Redis credentials tests
  - it: should create Redis password in secret
    set:
      config.hostname: test.example.com
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      config.redis.password: redispass123
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data["redis-password"]
          value: cmVkaXNwYXNzMTIz
          # Decodes to: redispass123

  - it: should create Redis username and password in secret
    set:
      config.hostname: test.example.com
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      config.redis.username: redisuser
      config.redis.password: redispass123
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data["redis-username"]
          value: cmVkaXN1c2Vy
          # Decodes to: redisuser
      - equal:
          path: data["redis-password"]
          value: cmVkaXNwYXNzMTIz
          # Decodes to: redispass123

  - it: should not create secret when using Redis existingSecret
    set:
      config.hostname: test.example.com
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      config.redis.existingSecret: my-redis-secret
    asserts:
      - hasDocuments:
          count: 0

  # Netrc file tests
  - it: should create netrc file in secret
    set:
      config.hostname: test.example.com
      config.upstream.netrcFile: "machine example.com login user password pass"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data["netrc"]
          value: bWFjaGluZSBleGFtcGxlLmNvbSBsb2dpbiB1c2VyIHBhc3N3b3JkIHBhc3M=
          # Decodes to: machine example.com login user password pass

  - it: should not create secret when using existing netrc secret
    set:
      config.hostname: test.example.com
      config.upstream.existingNetrcSecret: my-netrc-secret
    asserts:
      - hasDocuments:
          count: 0

  # Combined scenarios
  - it: should create secret with multiple credential types
    set:
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      config.database.type: postgresql
      config.database.postgresql.host: postgres
      config.database.postgresql.password: pgpass
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      config.redis.password: redispass
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["s3-access-key-id"]
      - exists:
          path: data["s3-secret-access-key"]
      - exists:
          path: data["postgres-password"]
      - exists:
          path: data["database-url"]
      - exists:
          path: data["redis-password"]
