suite: test deployment and statefulset rendering
templates:
  - deployment.yaml
  - statefulset.yaml
  - configmap.yaml
  - secret.yaml
  - secret-signing-key.yaml
tests:
  # Deployment mode tests
  - it: should create Deployment when mode is deployment
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ncps

  - it: should not create Deployment when mode is statefulset
    template: deployment.yaml
    set:
      mode: statefulset
      config.hostname: test.example.com
    asserts:
      - hasDocuments:
          count: 0

  # StatefulSet mode tests
  - it: should create StatefulSet when mode is statefulset
    template: statefulset.yaml
    set:
      mode: statefulset
      config.hostname: test.example.com
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ncps

  - it: should not create StatefulSet when mode is deployment
    template: statefulset.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
    asserts:
      - hasDocuments:
          count: 0

  # Replica count tests
  - it: should set correct replica count in Deployment
    template: deployment.yaml
    set:
      mode: deployment
      replicaCount: 3
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      config.database.type: postgresql
      config.database.postgresql.host: postgres
      config.database.postgresql.password: test123
      config.cdc.enabled: true
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      migration.mode: job
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set correct replica count in StatefulSet
    template: statefulset.yaml
    set:
      mode: statefulset
      replicaCount: 2
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres
      config.database.postgresql.password: test123
      config.cdc.enabled: true
      config.redis.enabled: true
      config.redis.addresses:
        - redis:6379
      migration.mode: job
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  # Image configuration tests
  - it: should use custom image registry
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      image.registry: custom.registry.io
      image.repository: my-org/ncps
      image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom.registry.io/my-org/ncps:v1.2.3

  - it: should use global image registry override
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      global.imageRegistry: global.registry.io
      image.registry: custom.registry.io
      image.repository: my-org/ncps
      image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: global.registry.io/my-org/ncps:v1.2.3

  # Security context tests
  - it: should set pod security context
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000

  - it: should set container security context
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  # Resource tests
  - it: should set resource limits and requests
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      resources:
        limits:
          cpu: 2000m
          memory: 2Gi
        requests:
          cpu: 100m
          memory: 256Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi

  # Probes tests
  - it: should configure liveness probe
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      livenessProbe:
        httpGet:
          path: /healthz
          port: http
        initialDelaySeconds: 20
        periodSeconds: 15
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 20
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 15

  - it: should configure readiness probe
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      readinessProbe:
        httpGet:
          path: /healthz
          port: http
        initialDelaySeconds: 10
        periodSeconds: 5
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5

  # Service account tests
  - it: should use custom service account
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      serviceAccount.create: true
      serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa

  # Node selector, tolerations, affinity tests
  - it: should set node selector
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should set tolerations
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "key1"
            operator: "Equal"
            value: "value1"
            effect: "NoSchedule"

  - it: should set affinity
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity.nodeAffinity

  # Extra configuration tests
  - it: should add extra environment variables
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      extraEnvVars:
        - name: CUSTOM_VAR
          value: custom-value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: custom-value

  - it: should add extra volumes and volume mounts
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
      extraVolumes:
        - name: custom-volume
          emptyDir: {}
      extraVolumeMounts:
        - name: custom-volume
          mountPath: /custom
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: custom-volume
            emptyDir: {}
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: custom-volume
            mountPath: /custom

  # Init container for SQLite directory creation
  - it: should create init container for SQLite directory creation in StatefulSet
    template: statefulset.yaml
    set:
      mode: statefulset
      config.hostname: test.example.com
      config.database.type: sqlite
      config.database.sqlite.path: /storage/db/ncps.db
    asserts:
      - isNotEmpty:
          path: spec.template.spec.initContainers
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: create-db-dir

  - it: should create init container for SQLite directory creation in Deployment
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.database.type: sqlite
      config.database.sqlite.path: /storage/db/ncps.db
      config.storage.type: local
      config.storage.local.persistence.enabled: false # Use emptyDir for this test
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: create-db-dir

  # Strategy tests
  - it: should render strategy.type when strategy is provided
    template: deployment.yaml
    set:
      mode: deployment
      strategy:
        type: Recreate
    asserts:
      - equal:
          path: spec.strategy.type
          value: Recreate

  - it: should render RollingUpdate strategy by default when strategy is not provided and database is not sqlite
    template: deployment.yaml
    set:
      mode: deployment
      config:
        database:
          type: postgresql
          postgresql:
            host: localhost
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate

  - it: should set strategy type to Recreate for SQLite in Deployment
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.database.type: sqlite
      config.storage.type: local
      config.storage.local.persistence.enabled: false
    asserts:
      - equal:
          path: spec.strategy.type
          value: Recreate

  - it: should set strategy type to RollingUpdate for PostgreSQL in Deployment
    template: deployment.yaml
    set:
      mode: deployment
      config.hostname: test.example.com
      config.database.type: postgresql
      config.database.postgresql.host: postgres
      config.database.postgresql.password: test123
      config.storage.type: s3
      config.storage.s3.bucket: my-bucket
      config.storage.s3.endpoint: https://s3.amazonaws.com
      config.storage.s3.accessKeyId: test-key
      config.storage.s3.secretAccessKey: test-secret
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
